#!/usr/bin/env bash

# Format code after making changes
# Usage: bin/cursor_agent_format_code

set -e

echo "üîß Setting up environment..."

# Setup Node.js
export PATH="$HOME/.nodenv/bin:$PATH"
if command -v nodenv >/dev/null 2>&1; then
  eval "$(nodenv init -)"
fi

# Use project dependencies instead of global npx to ensure version consistency
USE_PROJECT_DEPS=${USE_PROJECT_DEPS:-true}

if [ "$USE_PROJECT_DEPS" = "true" ]; then
  PRETTIER_CMD="npm exec -- prettier"
  ESLINT_CMD="npm exec -- eslint"
  LEFTHOOK_CMD="npm exec -- lefthook"
else
  PRETTIER_CMD="npx prettier"
  ESLINT_CMD="npx eslint"
  LEFTHOOK_CMD="npx lefthook"
fi

echo "‚ú® Formatting frontend files (JS/TS/CSS/Markdown)..."
$PRETTIER_CMD --write '**/*.{js,jsx,ts,tsx,css,md,html,json,yaml,yml}' || {
  echo "‚ö†Ô∏è Prettier formatting failed, but continuing..."
}

echo "üßπ Running ESLint auto-fix..."
$ESLINT_CMD --fix '**/*.{js,jsx,ts,tsx}' || {
  echo "‚ö†Ô∏è ESLint auto-fix failed, but continuing..."
}

echo "üöÄ Running lefthook formatting..."
$LEFTHOOK_CMD run fix || {
  echo "‚ö†Ô∏è Lefthook failed, but frontend formatting completed"
}

echo "‚úÖ Formatting complete!"