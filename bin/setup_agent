#!/usr/bin/env ruby

require "fileutils"

# == Helpers
# Path to your application root.
APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

unless ENV["MISE_ENV_LOADED"]
  Dir.chdir(APP_ROOT) do
    unless system("command -v mise", out: File::NULL)
      abort("mise isn't installed. Install it (e.g. brew install mise) before running bin/setup_agent.")
    end

    puts "=> Installing runtime tool versions"
    system!("mise", "trust", "--yes", "mise.toml")
    system!("mise", "install")
    puts "Runtime tools installed"

    exec(ENV.to_h.merge("MISE_ENV_LOADED" => "1"), "mise", "exec", "--", __FILE__, *ARGV)
  end
end

# == Command
FileUtils.chdir APP_ROOT do
  # This script is a way to set up or update your development environment
  # automatically. This script is idempotent, so that you can run it at any time
  # and get an expectable outcome.
  #
  # Add necessary setup steps to this file.

  puts "\n=> Installing Ruby dependencies"
  system("bundle check") || system!("bundle install")

  puts "\n=> Installing Node dependencies"
  system!("npm install") &&
    puts("Node dependencies are installed")

  puts "\n=> Installing git hooks"
  system! "bin/lefthook install"
end
